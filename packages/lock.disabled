#

homeassistant:

# switch:
#   - platform: lock
#     entity_id: sidedoor_lock_locked
#     name: Side Door Lock

group:
  locks:
    name: Lock
    entities:
      - lock.sidedoor_lock_locked
      - sensor.sidedoor_code
      - sensor.sidedoor_action
      - sensor.sidedoor_battery

sensor:
  - platform: template
    sensors:
      sidedoor_battery:
        entity_id: zwave.sidedoor_lock
        value_template: "{{ states.zwave.sidedoor_lock.attributes.battery_level }}"
        friendly_name: 'Side Door Lock Battery'
        unit_of_measurement: '%'

      # this sensor is intended to capture the user number that was used during
      # the last operation that required a code to be entered.  it will persist
      # after subsequent other events (manual locking, etc.) that didn't involve
      # a user code
      sidedoor_code:
        friendly_name: Side Door Last Code
        entity_id:
          - sensor.sidedoor_lock_alarm_type
          - sensor.sidedoor_lock_alarm_level
        value_template: >-
          {% if is_state('sensor.sidedoor_lock_alarm_type', '18') or
                is_state('sensor.sidedoor_lock_alarm_type', '19') %}
            {% if not is_state('sensor.sidedoor_lock_alarm_level', '0') %}
              {{states('sensor.sidedoor_lock_alarm_level')}}
            {% else %}
              {# just provide previous value if no user code entered #}
              {{states('sensor.sidedoor_code')}}
            {% endif %}
          {% else %}
            {# just provide previous value if no user code entered #}
            {{states('sensor.sidedoor_code')}}
          {% endif %}

      sidedoor_action:
        friendly_name: 'Side Door Last Action'
        entity_id:
          - sensor.sidedoor_lock_alarm_type
          - sensor.sidedoor_lock_alarm_level
        value_template: >-
          {% if is_state('sensor.sidedoor_lock_alarm_type', '18') %}
            {% if is_state('sensor.sidedoor_lock_alarm_level', '0') %}
          Locked: Outside Keypad
            {% else %}
          Locked: User {{states('sensor.sidedoor_lock_alarm_level')}}
            {% endif %}
          {% elif is_state('sensor.sidedoor_lock_alarm_type', '19') %}
            Unlocked: User Code {{states('sensor.sidedoor_lock_alarm_level')}}
          {% elif is_state('sensor.sidedoor_lock_alarm_type', '21') %}
            Locked: {{[ 'Outside Lock', 'Inside Deadbolt', 'Outside Keypad' ][states('sensor.sidedoor_lock_alarm_level')|int]}}
          {% elif is_state('sensor.sidedoor_lock_alarm_type', '22') %}
            Unlocked: Inside Deadbolt
          {% else %}
            Unknown: {{states('sensor.sidedoor_lock_alarm_type')}}/{{states('sensor.sidedoor_lock_alarm_level')}}
          {% endif %}
